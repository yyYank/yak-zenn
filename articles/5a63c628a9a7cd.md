---
title: "jaemk/cached ã‚’ä½¿ã£ã¦Rust(axum)ã§å‹•ãã‚µãƒ¼ãƒãƒ¼ã§ã‚¤ãƒ³ãƒ¡ãƒ¢ãƒªã‚­ãƒ£ãƒƒã‚·ãƒ¥ã‚’è©¦ã—ã¦ã¿ãŸ"
emoji: "ğŸ·"
type: "tech" # tech: æŠ€è¡“è¨˜äº‹ / idea: ã‚¢ã‚¤ãƒ‡ã‚¢
topics: ["rust"]
published: false
---


## TL;DR

ç°¡å˜ãªã‚¤ãƒ³ãƒ¡ãƒ¢ãƒªã‚­ãƒ£ãƒƒã‚·ãƒ¥ã¯ jaemk/cached ã§å®Ÿç¾ã§ãã‚‹ã€‚
https://crates.io/crates/cached
https://github.com/jaemk/cached

## ã‚µãƒ³ãƒ—ãƒ«ã‚³ãƒ¼ãƒ‰

https://github.com/yyYank/rust-sandbox/tree/master/cache-sample

```rust
use axum::Router;
use axum::routing::get;
use axum::extract;
use cached::{async_mutex, Cached, UnboundCache};
use cached::proc_macro::cached;

/*
cached! {
    TWICE_CACHE: SizedCache<String, String> = SizedCache::with_size(5000);
    fn cached_twice(id:String) -> String = {
        println!("{} not cached", id);
        return (id.parse::<i32>().unwrap() * 2).to_string();
    }
}
 */

#[cached (name="TWICE_CACHE")]
async fn cached_twice(id:String) -> String {
    println!("{} not cached", id);
    return format!("{} * 2 = {}", id, id.parse::<i32>().unwrap() * 2);
}

pub fn routes() -> Router{
    Router::new()
        .route("/cache/:id", get(get_cache))
        .route("/clear-cache/:id", get(clear_cache))
}

async fn get_cache(
    extract::Path(id) : extract::Path<String>
) -> String {
    cached_twice(id).await
}

async fn clear_cache(
    extract::Path(id) : extract::Path<String>
) -> String {
    {
        let mut cache : async_mutex::MutexGuard<UnboundCache<String, String>>= TWICE_CACHE.lock().await;
        cache.cache_remove(&id);
    }
    return format!("{} cache clear has done", id);
}
```

## ä½•ã‚’ã‚„ã£ã¦ã„ã‚‹ã‹


- ç°¡å˜ãªãƒªã‚¯ã‚¨ã‚¹ãƒˆã‚’2å€ã—ã¦è¿”ã™APIã‚µãƒ³ãƒ—ãƒ«
- `/cache/:id` ã§1å›ç›®ã«ã‚­ãƒ£ãƒƒã‚·ãƒ¥
- `/cache/:id` ã§2å›ç›®ä»¥é™ã¯ã‚­ãƒ£ãƒƒã‚·ãƒ¥ã•ã‚ŒãŸå€¤ãŒè¿”ã•ã‚Œã‚‹
- `/clear-cache/:id` ã§ã‚­ãƒ£ãƒƒã‚·ãƒ¥ã‚¯ãƒªã‚¢ 
- é¢å€’ã ã£ãŸã®ã§å…¨éƒ¨GETã«ã—ã¡ã‚ƒã£ãŸã‘ã©è¨±ã—ã¦æ¬²ã—ã„

## ä½¿ã„æ–¹

cachedã¯é–¢æ•°ã®çµæœã‚’ã‚­ãƒ£ãƒƒã‚·ãƒ¥ã—ã¦ãã‚Œã‚‹ãƒã‚¯ãƒ­ã‚’æä¾›ã—ã¦ãã‚Œã‚‹ã€‚
Function-likeãƒã‚¯ãƒ­ã¨attributeãƒã‚¯ãƒ­ã®æ›¸ãæ–¹ãŒå‡ºæ¥ã‚‹ã€‚

ãŸã asyncãªé–¢æ•°ã«å¯¾ã—ã¦ã¯ã©ã†ã‚„ã‚‰attributeãƒã‚¯ãƒ­ã®æ–¹å¼ã§ã—ã‹å¯¾å¿œã—ã¦ãã‚Œãªã„ã‚ˆã†ã§
Function-likeãƒã‚¯ãƒ­ã®æ›¸ãæ–¹ã ã¨ã‚¨ãƒ©ãƒ¼ã«ãªã£ãŸã€‚

axumã¨ã‹asyncã‚’ã¤ã‘ãŸã„å ´åˆã¯attributeãƒã‚¯ãƒ­ä¸€æŠã«ãªã‚Šãã†ã€‚

ã‚­ãƒ£ãƒƒã‚·ãƒ¥ã‚¯ãƒªã‚¢ã‚’ã—ãŸã‹ã£ãŸãŸã‚ã€
`name="TWICE_CACHE"`ã¨ã„ã†å½¢ã§ã‚­ãƒ£ãƒƒã‚·ãƒ¥ã®æ§‹é€ ä½“ã®åå‰ã‚’æ˜ç¤ºã™ã‚‹ã‚ˆã†ã«ã—ã¦ã„ã‚‹ã€‚
`TWICE_CACHE` ã¯lockã™ã‚‹ã“ã¨ã§æ“ä½œã§ãã‚‹ã£ã½ã„ã€‚

ã“ã®å ´åˆã¯ `async_mutex::MutexGuard<UnboundCache<String, String>>` ãŒå®Ÿä½“ã®å‹ã¨ãªã£ã¦ã„ã‚‹ã€‚

## ã¾ã¨ã‚

ã‚¤ãƒ³ãƒ¡ãƒ¢ãƒªã§é›‘ã«ã‚­ãƒ£ãƒƒã‚·ãƒ¥ã—ãŸã„æ™‚ã¯jaemk/cachedè‰¯ã„ã‹ã‚‚ã€‚

ãŸã ã‚µãƒ¼ãƒãƒ¼å†èµ·å‹•ã—ãŸã‚‰æ¶ˆãˆã‚‹ã—ã€è¤‡æ•°ã‚µãƒ¼ãƒãƒ¼ã ã¨ã‚­ãƒ£ãƒƒã‚·ãƒ¥ã¯å…±æœ‰ã•ã‚Œãªã„ã—ãªã©ã‚ã‚‹ã®ã§
ã¡ã‚ƒã‚“ã¨ã‚„ã‚‹ãªã‚‰redisã¨ã‹ãŒç„¡é›£ã‹ã‚‚ã€‚
